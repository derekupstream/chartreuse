# Technology Stack Research

**Project:** ChartReuse (derekupstream fork)
**Research Type:** Stack dimension — subsequent milestone
**Researched:** 2026-02-23
**Overall Confidence:** MEDIUM-HIGH

---

## Context: What This Research Covers

This is a **brownfield stack research file** for an existing Next.js 15 (pages router) + TypeScript + Prisma 6 + PostgreSQL app. The existing stack is documented in `.planning/codebase/STACK.md`. This file researches only the **new additions** needed for three improvements:

1. **Replace Firebase auth with email/password auth** (NextAuth.js v5 vs Better Auth)
2. **PDF export of the projections dashboard** (four options compared)
3. **Multi-year time-series projection charts** (extending existing `@ant-design/plots` usage)

---

## Part 1: Authentication Replacement (Firebase → Email/Password)

### Ecosystem Context (February 2026)

The auth landscape shifted significantly in late 2024: Auth.js (formerly NextAuth.js) was acquired by the Better Auth team. As announced officially: "Auth.js, formerly known as NextAuth.js, is now being maintained and overseen by Better Auth team." The Better Auth team stated they will address security patches and urgent issues for Auth.js but recommend new projects start with Better Auth.

**Key finding:** NextAuth.js v5 remains in beta (`5.0.0-beta.25` is the latest referenced build as of early 2026). Better Auth v1.0 was released as production-stable on November 22, 2024, and is now at `1.4.18` (npm, last published ~25 days before this research).

### Recommendation: Better Auth 1.4.18

**Use Better Auth.** Not NextAuth v5. Here is why.

| Criterion | Better Auth 1.4.18 | NextAuth.js v5 (beta) |
|-----------|--------------------|-----------------------|
| Release status | Stable (v1.0 Nov 2024, v1.4.x active) | Beta (`5.0.0-beta.25+`), no stable tag |
| Pages Router support | Yes — `toNodeHandler` pattern | Yes — `auth(context)` in `getServerSideProps` |
| Prisma adapter | Official, CLI-generated schema | `@auth/prisma-adapter` (separate package) |
| Email/password | `emailAndPassword: { enabled: true }` — built-in | CredentialsProvider (known limitations) |
| Session storage | Database sessions by default (works with Credentials) | JWT forced with Credentials (known bug/limitation: database sessions + Credentials fails) |
| Password hashing | Built-in (no manual bcrypt wiring) | Manual bcrypt in `authorize` callback |
| Rate limiting | Built-in plugin | Must implement manually |
| Firebase migration | On-demand migration pattern documented, auto-link by email | No Firebase migration docs |
| Ecosystem trajectory | Active development, Auth.js team joined | "No new feature work" per Better Auth team |
| TypeScript | Full type safety, auto-inferred | Good but less opinionated |

**The critical technical issue with NextAuth v5 for this project:** When using the CredentialsProvider (email/password) with Auth.js v5 and a database adapter, you cannot use database sessions — you are forced to use JWT sessions. This is a documented limitation (`Credentials provider not working w/ database session strategy · Issue #9636`). Better Auth does not have this constraint: it uses database sessions for email/password by default, which enables session revocation, "sign out everywhere," and auditing.

### What NOT to Use

- **NextAuth.js v5 beta**: Still in beta as of early 2026. The Auth.js team explicitly states no new feature work. The Credentials+database session bug is a fundamental limitation for this use case. **Avoid.**
- **Clerk**: Managed SaaS auth. Eliminates control over user data and adds $0-99+/month cost. Overkill for a personal fork. **Avoid.**
- **Firebase Auth (status quo)**: Two SDKs (`firebase` + `firebase-admin`), 6+ environment variables, cookie-based token flow, external dependency for every auth check. The entire reason we're migrating. **Remove.**
- **Auth0**: Another managed SaaS. Same objections as Clerk. **Avoid.**
- **Lucia Auth**: Archived as of early 2024. **Do not use.**

### Better Auth: Precise Setup for This Project

**Installation:**
```bash
yarn add better-auth
yarn add bcryptjs
yarn add -D @types/bcryptjs @better-auth/cli
```

**Pages Router API handler** (`pages/api/auth/[...all].ts`):
```typescript
import { toNodeHandler } from "better-auth/node"
import { auth } from "lib/auth"

export const config = { api: { bodyParser: false } }
export default toNodeHandler(auth.handler)
```

**Schema generation:**
```bash
npx @better-auth/cli generate
npx prisma migrate dev --name add-better-auth
```

**Required Prisma models** (auto-generated by CLI):
- `User` — name, email, emailVerified (boolean), image, createdAt, updatedAt
- `Session` — token, expiresAt, ipAddress, userAgent, userId, createdAt, updatedAt
- `Account` — accountId, providerId, userId, accessToken, refreshToken, accessTokenExpiresAt, refreshTokenExpiresAt, scope, password, createdAt, updatedAt
- `Verification` — identifier, value, expiresAt, createdAt, updatedAt

**Critical schema migration issue:** The existing `User` model uses Firebase UID as the primary key (`id`). Better Auth auto-generates `cuid()` IDs. The migration strategy must:
1. Add Better Auth tables alongside existing tables (not rename User)
2. Map existing user data to Better Auth's schema via column mapping OR run a data migration
3. Use the on-demand migration pattern: when a user's email matches an existing record, link accounts

**Firebase UID migration path** (proven by a real production migration in April 2025):
1. Keep Firebase active temporarily
2. On first Better Auth login, check if user email exists in DB
3. If found without Better Auth account: verify against Firebase, then create Better Auth account, hash and store password
4. After transition window: remove Firebase SDKs and env vars
5. Reference: https://saulotauil.com/2025/04/17/firebase-auth-to-better-auth.html

**New environment variables:**
```
BETTER_AUTH_SECRET=<random 32+ char string>
BETTER_AUTH_URL=https://yourdomain.com  # or auto-detected
```

**Removed environment variables (after full migration):**
```
NEXT_PUBLIC_FIREBASE_API_KEY
NEXT_PUBLIC_FIREBASE_ADMIN_PROJECT_ID
NEXT_PUBLIC_FIREBASE_PROJECT_NUMBER
NEXT_PUBLIC_FIREBASE_APP_ID
FIREBASE_ADMIN_EMAIL
FIREBASE_ADMIN_PRIVATE_KEY
```

**Session access in `getServerSideProps`:**
```typescript
import { auth } from "lib/auth"
import { toNextJsHandler } from "better-auth/next-js"

// In getServerSideProps:
const session = await auth.api.getSession({ headers: context.req.headers })
if (!session) return { redirect: { destination: '/login', permanent: false } }
```

**Confidence:** MEDIUM-HIGH — Better Auth v1.x stable confirmed via npm and official release notes. Pages Router pattern confirmed via official docs. Firebase migration strategy confirmed via real production case study from 2025.

---

## Part 2: PDF Export of Projections Dashboard

### What Exists in the Codebase

The app already has `react-to-print` v2.14 installed and actively used in `components/common/print/PrintButton.tsx`. It uses `useReactToPrint` to trigger the browser's native print dialog. The projections dashboard (`ProjectionsStep.tsx`) already has a `printRef` and `PrintButton` wired up.

The existing print flow renders the React component tree directly to the browser print dialog. This means "PDF export" is already partially working via browser print-to-PDF. The limitation is: it uses the browser print dialog (not a clean PDF download), has no control over paper size/margins from code, and produces browser-quality output rather than a precise document PDF.

### Options Analysis

#### Option A: Enhance Existing react-to-print (Upgrade Path)
- **Current version:** 2.14.11 (already in package.json)
- **What it does:** Triggers `window.print()` with a cloned DOM subtree. User sees browser print dialog.
- **Pros:** Zero new dependencies, already works, renders existing React components faithfully including Ant Design charts (SVGs render correctly because it's real browser rendering)
- **Cons:** Not a programmatic PDF download. Depends on user's browser. No server-side generation. Can't generate PDF without user interaction.
- **For this use case:** Acceptable for "print to PDF" UX, but not suitable if the goal is a server-generated downloadable PDF (e.g., for an API endpoint or shareable link)
- **Confidence:** HIGH (working in codebase today)

#### Option B: Puppeteer (Headless Chrome Server-Side)
- **Packages:** `puppeteer-core` + `@sparticuz/chromium-min`
- **Versions (as of late 2025):** `puppeteer-core@23.10.4`, `@sparticuz/chromium-min@131.0.1`
- **How it works:** API route spins up headless Chrome, navigates to the projection page URL, calls `page.pdf()`
- **Pros:** Pixel-perfect rendering of existing page. SVG charts render correctly (Ant Design uses SVG via G2/G2Plot). No need to rebuild the UI in a different format.
- **Cons for Vercel:**
  - 250MB function bundle size limit — standard Puppeteer is too large; requires `@sparticuz/chromium-min` + `puppeteer-core` combination
  - Slow on serverless: 4-8x slower than dev machine per Vercel documentation
  - Timeout risk: Vercel Hobby = 10s max, Pro = 60s max. PDF generation of complex page can exceed 10s.
  - Chromium binary downloaded at runtime (adds latency, CDN dependency)
  - Authentication: the API route must authenticate to the projection page (pass session cookies)
- **Confidence:** MEDIUM — technical approach confirmed working, Vercel constraints confirmed, but runtime performance on free/hobby tier is a real risk

#### Option C: @react-pdf/renderer (React-to-PDF Document)
- **Package:** `@react-pdf/renderer`
- **Current version:** ~4.x (860K+ weekly downloads, 15,900+ GitHub stars as of mid-2025)
- **How it works:** You write a parallel PDF document using `<Document>`, `<Page>`, `<View>`, `<Text>` components. Renders as a PDF stream via Node.js.
- **Pros:** Lightweight, no headless browser, reliable server-side generation, client-side generation possible, precise control over layout
- **Cons for this project:** You must **rebuild the entire projections dashboard as a react-pdf document**. The existing `ProjectionsStep`, `FinancialSummary`, `EnvironmentalSummary`, and all chart components cannot be reused. Charts (Ant Design `Bar`, `Line` etc.) cannot render inside react-pdf — you would need to either omit charts, replace with static data tables, or convert chart SVGs to images first.
- **Not recommended for this use case:** The dashboard is complex (KPI cards, financial tables, environmental summary, bar charts). Rebuilding as react-pdf is significant parallel work, and charts are a central feature of the export.
- **Confidence:** HIGH on library capability, HIGH on the "rebuilding required" limitation

#### Option D: jsPDF + html2canvas
- **Packages:** `jspdf` + `html2canvas`
- **How it works:** html2canvas screenshots the DOM to a canvas, jsPDF embeds the canvas image
- **Critical issue:** html2canvas does not support SVG elements. The Ant Design charts (via AntV G2) render as SVG. This means charts will be **blank or missing** in the PDF. Multiple GitHub issues confirm this is a longstanding, unfixed limitation of html2canvas.
- **Not recommended.** The chart SVG limitation is a fundamental blocker for this dashboard.
- **Confidence:** HIGH on the limitation (confirmed via multiple GitHub issues and community reports)

### Recommendation: Two-Phase PDF Strategy

**Phase 1 (quick win, ship now):** Upgrade `react-to-print` to v3.x and improve the existing print flow. Add `@media print` CSS to hide nav/buttons, set paper size via CSS (`@page { size: A4 landscape; }`), and document the "use browser → Save as PDF" workflow. This is zero additional dependency and already works.

**Phase 2 (server-generated PDF download):** Use Puppeteer (`puppeteer-core` + `@sparticuz/chromium-min`) with a dedicated Vercel serverless function. Required for:
- Programmatic PDF generation from share links
- Removing user browser dialog from the flow
- Future API endpoint that returns a PDF

For Phase 2, upgrade Vercel plan to Pro (60s timeout) or use a separate long-running endpoint on Heroku (already in the stack) to avoid Vercel's 10s serverless timeout.

**What NOT to use:**
- `@react-pdf/renderer` — requires rebuilding the entire dashboard UI. Not worth it when Puppeteer can render the existing page.
- `jsPDF + html2canvas` — SVG chart rendering is broken. Do not use.
- `playwright` — functionally equivalent to Puppeteer for this use case but less documentation for Vercel serverless deployment. Puppeteer + `@sparticuz/chromium-min` is the more proven pattern on Vercel.

**Installation for Phase 2:**
```bash
yarn add puppeteer-core
yarn add @sparticuz/chromium-min
```

**next.config.js additions:**
```js
serverExternalPackages: ['@sparticuz/chromium-min'],
webpack: (config) => {
  config.externals = [...(config.externals || []), '@sparticuz/chromium-min']
  return config
}
```

**Confidence:** MEDIUM-HIGH — Puppeteer+Vercel pattern confirmed with required packages, timeout risk is real and documented.

---

## Part 3: Multi-Year Time-Series Projection Charts

### Current State

The app uses `@ant-design/plots` 2.3 for all charts. Charts are dynamically imported (`next/dynamic` with `{ ssr: false }`) because Ant Design Charts does not support SSR. Current charts are single-year bar charts showing baseline vs forecast.

The target is multi-year curves: year 1 through year N showing cumulative GHG savings, cost trajectory, waste reduction, and payback period crossover.

### Recommendation: Stay on @ant-design/plots

**No new chart library is needed.** `@ant-design/plots` 2.3 (already in the stack) fully supports multi-year time-series via two chart types:

**Line chart** — for single metric over time (e.g., cumulative GHG savings by year):
```typescript
import dynamic from 'next/dynamic'
const Line = dynamic(() => import('@ant-design/plots').then(r => r.Line), { ssr: false })

const config = {
  data: multiYearData,  // [{ year: '2024', value: 0 }, { year: '2025', value: 15.3 }, ...]
  xField: 'year',
  yField: 'value',
}
```

**DualAxes chart** — for comparing two metrics with different scales on the same time axis (e.g., cumulative cost savings vs. GHG avoided, or baseline cost vs. reusable cost):
```typescript
const DualAxes = dynamic(() => import('@ant-design/plots').then(r => r.DualAxes), { ssr: false })

const config = {
  data: [financialData, environmentalData],
  xField: 'year',
  yField: ['cost', 'ghg'],
  geometryOptions: [
    { geometry: 'line', smooth: true },
    { geometry: 'line', smooth: true, lineStyle: { lineDash: [4, 4] } }
  ]
}
```

**Area chart** — for showing cumulative savings area under a curve (visually compelling for environmental impact):
```typescript
const Area = dynamic(() => import('@ant-design/plots').then(r => r.Area), { ssr: false })
```

**Current @ant-design/plots 2.3 supports (confirmed via official gallery at ant-design-charts.antgroup.com):**
- Line, DualAxes, Area, Column, Bar — all available
- Multi-series line charts with `seriesField` for multiple lines on same chart
- Custom tooltips with value formatters
- Annotations (e.g., marking the payback period crossover point)
- Export via `chart.downloadImage()` method

### No Additional Library Needed

The existing `@ant-design/plots` 2.3 handles everything needed for multi-year projections. What IS needed is:

1. **Calculator extension** (`lib/calculator/`) — the engine must produce multi-year arrays instead of single-year scalars. This is a pure TypeScript change, not a library change.
2. **New chart components** that consume the multi-year arrays and render Line/DualAxes charts using the existing `next/dynamic` import pattern already established in the codebase.

### What NOT to Use

- **Recharts**: Popular, but switching away from `@ant-design/plots` would create visual inconsistency and require rewriting all existing chart components. Not worth it.
- **Chart.js / react-chartjs-2**: Same objection. Also heavier for tree-shaking.
- **D3.js**: Maximum flexibility but massive implementation cost. The projections needed here are standard line charts, not novel visualizations. Overkill.
- **Nivo**: Good library but again, replacing `@ant-design/plots` in an Ant Design app creates inconsistency.

**Confidence:** HIGH — `@ant-design/plots` 2.3 is already installed and demonstrably supports Line, DualAxes, Area charts. DualAxes confirmed at `ant-design-charts.antgroup.com/en/components/plots/dual-axes` (v2.6.5 docs).

---

## Recommended Stack Changes Summary

### Add

| Library | Version | Purpose | Rationale |
|---------|---------|---------|-----------|
| `better-auth` | `^1.4.18` | Auth framework (email/password, session, RBAC) | Stable v1, works with Prisma + PostgreSQL, handles Firebase migration, no Credentials/database-session bug unlike NextAuth v5 |
| `@better-auth/cli` (dev) | latest | Prisma schema generation | Auto-generates required auth schema models |
| `puppeteer-core` | `^23.10.4` | Headless Chrome for server-side PDF generation | Renders existing React page including SVG charts faithfully |
| `@sparticuz/chromium-min` | `^131.0.1` | Chromium binary for serverless (Vercel-compatible) | Only Chromium package small enough for Vercel 250MB limit |

### Upgrade

| Library | From | To | Reason |
|---------|------|----|--------|
| `react-to-print` | `^2.14.11` | `^3.x` | v3 adds `useReactToPrint` hook improvements and better TypeScript types; Phase 1 PDF improvement |

### Remove (after auth migration)

| Library | Version | Why |
|---------|---------|-----|
| `firebase` | `10.9` | Replaced by Better Auth |
| `firebase-admin` | `13.4` | Replaced by Better Auth server-side session |
| `nookies` | `2.5` | Used exclusively for Firebase token cookie handling; not needed with Better Auth |

### No Change Needed

| Library | Why Kept |
|---------|---------|
| `@ant-design/plots` 2.3 | Already supports Line, DualAxes, Area for multi-year curves |
| Prisma 6.10 + PostgreSQL | Better Auth uses Prisma as its adapter — alignment, not conflict |
| All Stripe libraries | Not touched by any of these improvements |
| `exceljs` | Not affected |
| `react-query` / `swr` | Not affected |

---

## Installation Commands

```bash
# Auth replacement
yarn add better-auth
yarn add -D @better-auth/cli

# After adding better-auth to lib/auth.ts with prismaAdapter:
npx @better-auth/cli generate
npx prisma migrate dev --name add-better-auth-tables

# PDF generation (Phase 2 only — defer until needed)
yarn add puppeteer-core
yarn add @sparticuz/chromium-min

# react-to-print upgrade (Phase 1)
yarn upgrade react-to-print@^3
```

---

## Environment Variables: Delta

**Add:**
```
BETTER_AUTH_SECRET=<openssl rand -hex 32>
BETTER_AUTH_URL=https://chartreuse.vercel.app  # auto-detected on Vercel but explicit is safer
```

**Remove (after migration complete):**
```
NEXT_PUBLIC_FIREBASE_API_KEY
NEXT_PUBLIC_FIREBASE_ADMIN_PROJECT_ID
NEXT_PUBLIC_FIREBASE_PROJECT_NUMBER
NEXT_PUBLIC_FIREBASE_APP_ID
FIREBASE_ADMIN_EMAIL
FIREBASE_ADMIN_PRIVATE_KEY
```

---

## Migration Risk Register

| Risk | Severity | Mitigation |
|------|----------|-----------|
| Firebase UID is existing User PK — Better Auth generates new IDs | HIGH | Run parallel Better Auth tables; map existing users by email during on-demand migration. Do NOT drop existing User table until all users have migrated. |
| Prisma User model name conflict — Better Auth needs a `user` model | MEDIUM | Better Auth CLI generates a new User model; reconcile with existing Prisma model via column mapping or rename existing model to `LegacyUser` during migration |
| Stripe customer linkage — `Org.stripeCustomerId` is not on User | LOW | Stripe is on Org model, not User; Better Auth replaces User auth only. No Stripe impact. |
| Vercel timeout on PDF generation | MEDIUM | Phase 1 (react-to-print) has no timeout risk. Phase 2 (Puppeteer): deploy PDF endpoint to Heroku (already in stack) or upgrade Vercel to Pro for 60s timeout. |
| Chart SVG rendering in PDF | LOW (if Puppeteer) / HIGH (if html2canvas/jsPDF) | Use Puppeteer path only; Puppeteer renders SVGs correctly. Do not use html2canvas. |
| `@sparticuz/chromium-min` cold start latency | MEDIUM | CDN delivery of Chromium binary adds 2-5s cold start. Cache binary between invocations where possible. Document expected latency. |

---

## Confidence Assessment

| Area | Level | Basis |
|------|-------|-------|
| Better Auth recommendation | HIGH | Official docs, v1.0 stable release notes, npm version confirmed, Prisma integration official Prisma docs |
| NextAuth v5 limitations | HIGH | Official GitHub issues, Auth.js team's own statement about no new feature work |
| Firebase migration pattern | MEDIUM-HIGH | Single detailed production case study from April 2025, official Better Auth migration guide |
| Puppeteer on Vercel | MEDIUM | Official Vercel KB article, multiple community implementations; timeout risk is real |
| @ant-design/plots for time series | HIGH | Already in codebase, DualAxes/Line confirmed in official gallery (v2.6.5 docs) |
| html2canvas SVG limitation | HIGH | Multiple GitHub issues in jsPDF and html2canvas repos, consistently reported |
| react-to-print upgrade path | HIGH | Already working in codebase; v3 is backward-compatible |

---

## Sources

- [Auth.js is now part of Better Auth (official announcement)](https://www.better-auth.com/blog/authjs-joins-better-auth)
- [Better Auth v1.0 Release Notes](https://www.better-auth.com/v1)
- [Better Auth Installation Docs](https://www.better-auth.com/docs/installation)
- [Better Auth Next.js Integration (Pages Router)](https://www.better-auth.com/docs/integrations/next)
- [Better Auth Migration from Auth.js](https://www.better-auth.com/docs/guides/next-auth-migration-guide)
- [Prisma + Better Auth + Next.js (official Prisma docs)](https://www.prisma.io/docs/guides/betterauth-nextjs)
- [Firebase to Better Auth migration (production case study)](https://saulotauil.com/2025/04/17/firebase-auth-to-better-auth.html)
- [Auth.js Migrating to v5](https://authjs.dev/getting-started/migrating-to-v5)
- [Auth.js Prisma Adapter](https://authjs.dev/getting-started/adapters/prisma)
- [NextAuth Credentials + Database Session bug](https://github.com/nextauthjs/next-auth/issues/9636)
- [Auth.js Session Strategies](https://authjs.dev/concepts/session-strategies)
- [Deploying Puppeteer with Next.js on Vercel (official Vercel KB)](https://vercel.com/kb/guide/deploying-puppeteer-with-nextjs-on-vercel)
- [PDF Generation Libraries Comparison (January 2025)](https://dmitriiboikov.com/posts/2025/01/pdf-generation-comarison/)
- [html2canvas SVG not supported (GitHub issue)](https://github.com/niklasvh/html2canvas/issues/1430)
- [Ant Design Charts DualAxes documentation](https://ant-design-charts.antgroup.com/en/components/plots/dual-axes)
- [Ant Design Charts GitHub](https://github.com/ant-design/ant-design-charts)
- [better-auth npm package (v1.4.18)](https://www.npmjs.com/package/better-auth)
